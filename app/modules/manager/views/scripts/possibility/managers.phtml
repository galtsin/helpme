<?php
// Справочник ролей для JS
$roles = array();
foreach(HM_Model_Account_Access::getInstance()->getRoles() as $role) {
    $roles[] = $role->toArray();
}
$rolesJson = Zend_Json::encode($roles);

// Загрузить в коллекцию список разрешенных на редактирование прав менеджеров
$possibilities = $this->possibilities;
$userColl = new HM_Model_Account_User_Collection();
foreach($possibilities as $possibility) {
    $userColl->load($possibility->getData('user'));
}

// Справочник для JS
$rolesWithInheritance = $companiesIndex= array();
foreach($this->rolesWithInheritance as $roleIdentifier => $companies) {
    $rolesWithInheritance[] = array(
        'code'      => $roleIdentifier,
        'companies' => $companies
    );
    $companiesIndex = array_merge($companiesIndex, $companies);
}
$rolesWithInheritanceJson = Zend_Json::encode($rolesWithInheritance);

// Справочник для JS
$companyColl = new HM_Model_Billing_Company_Collection();
foreach(array_values(array_unique($companiesIndex)) as $company) {
    $companyColl->load($company);
}
$companiesJson = Zend_Json::encode($companyColl->toArray());

?>
<?php
$jScript = <<<JS
require([
    "dojo/dom",
    "dojo/dom-attr",
    "dojo/dom-form",
    "dojo/on",
    "dojo/_base/lang",
    "dojo/query",
    "dojo/router",
    "dojo/store/Memory",
    "core/Layout",
    "core/helper/Validation",
    "core/helper/Form",
    "dijit/Dialog"
], function(dom, domAttr, domForm, on, lang, query, router, storeMemory, coreLayout, coreValidation, coreHelperForm, dijitDialog){
    dojo.ready(function(){

        var Layout = new coreLayout({
            messenger: {
                node: dom.byId('messenger')
                },
            processing: {
                node: dom.byId('loader')
                }
        });

        // Хранилище системных ролей
        var storeRoles = new storeMemory({data: $rolesJson});

        // Хранилище информации о компаниях доступных текущему администратору
        var storeCompanies = new storeMemory({data: $companiesJson});

        // Связка связи Роль-Компания
        var storeHierarchyRoleAndCompanies = new storeMemory({data: $rolesWithInheritanceJson});

        var DialogBox = new dijitDialog();

        // #Страница с менеджерами
        router.register('main', function(){
            // Получение менеджера
            query('[data-action^="getManagerBoard/"]').on('click', function(event){
                event.preventDefault();
                router.go(event.target.getAttribute("data-action"));
            });

            query('[data-action^="addPossibility"]').on('click', function(event){
                event.preventDefault();
                dojo.publish('addPossibility');
            });
        });

        // #Страница с настройками одного менеджера
        router.register('getManagerBoard/:manager', function(event){
            dojo.publish('getManagerBoard', event.params);
        });

        // Startup must be called in order to "activate" the router
        router.startup();
        router.go('main');

        dojo.subscribe('getManagers', function(){

        });

        dojo.subscribe('getManagerBoard', function(args){
            Layout.load({
                url:    '../../../manager/possibility/get-manager-board',
                format: 'html',
                args:   args
            }).then(function(response){
                Layout.place(dom.byId('contentManagers'), response);
            }).then(function(){
                // Навешиваем события
                query('[data-action^="editPossibilityObjects"]').on('click', function(event){
                    event.preventDefault();
                    dojo.publish('editPossibilityObjects', {possibility: domAttr.get(event.target, "data-action").split('/')[1]});
                });
            }).then(function(){
                query('[data-action^="addPossibility"]').on('click', function(event){
                    event.preventDefault();
                    dojo.publish('addPossibility', {manager: domAttr.get(event.target, "data-action").split('/')[1]});
                });
            }).then(function(){
                query('[data-action^="removePossibility"]').on('click', function(event){
                    event.preventDefault();
                    dojo.publish('removePossibility', {
                            possibility: domAttr.get(event.target, "data-action").split('/')[1],
                            manager: args['manager']
                        }
                    );
                });
            })
        });

        // Действие на редактирование объектов
        dojo.subscribe('editPossibilityObjects', function(args){
            Layout.load({
                url:    appConfig.baseUrl + '/manager/possibility/edit-possibility-objects',
                format: 'html',
                args:   args
            }).then(function(response){
                DialogBox.set('content', response);
                DialogBox.set('title', "Редактирование ресурсов");
                DialogBox.show();
            }).then(function(){
                var form = dom.byId('edit-possibility-objects');

                on(form['add'], 'click', function(){
                    coreHelperForm.moveSelectedOptions(form['available'], form['selected']);
                });
                on(form['remove'], 'click', function(){
                    coreHelperForm.moveSelectedOptions(form['selected'], form['available']);
                });

                on(dom.byId('_d_'), 'click', function(event){
                    var selected = [];
                    for(var i = 0, len = form['selected'].options.length; i < len; i ++) {
                        selected.push(form['selected'].options[i].value);
                    }
                    var args = domForm.toObject(event.target.form);
                    args['objects[]'] = selected;
                    Layout.send({
                        url:    appConfig.baseUrl + '/manager/possibility/edit-possibility-objects',
                        args:   args
                    }).then(function(response){
                        if(response.result && response.result != -1) {
                            DialogBox.hide();
                        }
                    });
                });
            })
        });

        dojo.subscribe('removePossibility', function(args){
            Layout.send({
                url:    appConfig.baseUrl + '/manager/possibility/remove-possibility',
                args:   args
            }).then(function(response){
                if(response.result && response.result != -1) {
                    dojo.publish('getManagerBoard', args);
                }
            })
        });

        // Действие на добавление нового Possibility
        dojo.subscribe('addPossibility', function(args){
            Layout.load({
                url:    appConfig.baseUrl + '/manager/possibility/add-possibility',
                format: 'html',
                args:   args
            }).then(function(response){
                DialogBox.set('content', response);
                DialogBox.set('title', "Редактирование ресурсов");

                var form = dom.byId('add-possibility');
                var Validation = new coreValidation(form);
                var formEvents = {
                    changeRole: function(){
                        storeHierarchyRoleAndCompanies.query({'code': storeRoles.get(domForm.fieldToObject(form['possibility[role]']))['data']['code']}).forEach(function(items){
                            var html = '';
                            dojo.forEach(items['companies'], function(company){
                                html += '<option value="' + company + '" >' + storeCompanies.get(company)['data']['name'] + '</option>';
                            });
                            form['possibility[company]'].length = 0;
                            form['possibility[company]'].innerHTML = html;
                        });
                    },
                    onSend: function(){
                        if(Validation.isValid()) {
                            Layout.send({
                                url:    appConfig.baseUrl + '/manager/possibility/add-possibility',
                                args:   domForm.toObject(form)
                            }).then(function(response){
                                 if(response.result && response.result != -1) {
                                    DialogBox.hide();
                                    setTimeout(function(){
                                        dojo.publish('getManagerBoard', {manager: domForm.fieldToObject(form['possibility[user]'])});
                                    }, Layout._delay);
                                } else {
                                    Validation.clear();
                                    Validation.setMessages(response.error);
                                }
                            });
                        }
                    }
                };

                on(form['possibility[role]'], 'change', formEvents.changeRole);
                on(form['send'], 'click', formEvents.onSend);

                (function(){
                    formEvents.changeRole();
                    DialogBox.show();
                })();
            });
        });

    });
});

JS;
$this->headScript()->appendScript($jScript, $type = 'text/javascript')
?>
<div id="contentManagers">
    <table class="table table-bordered">
        <colgroup>
            <col width="50">
            <col>
        </colgroup>
        <thead>
            <tr>
                <th>#</th>
                <th>Пользователь</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <td colspan="2">
                    <button type="button" data-action="addPossibility" name="add">Добавить</button>
                    <button type="button" data-action="removeManager" name="remove" id="testme">Удалить</button>
                </td>
            </tr>
        </tfoot>
        <tbody>
            <?php foreach($userColl->getDataIterator() as $manager): ?>
            <tr>
                <td><input type="checkbox"/></td>
                <td><a data-action="getManagerBoard/<?=$manager->get('id')?>"><?=$manager->get('email')?></a></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>